<?xml version="1.0"?>
<!-- FRE Usage documentation: http://www.gfdl.noaa.gov/fms/fre -->
<!-- $Id: OM4.xml,v 1.1.2.12.2.6.2.3 2014/05/23 19:37:49 Niki.Zadeh Exp $ -->
<!DOCTYPE setup [
<!ENTITY ROOT_LOCATION "/lustre/f1/unswept">
<!ENTITY ARCH_LOCATION "/lustre/f1">
]>

<!--
Quick start guide

module load fre/bronx-7
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS_libs_compile -no-link
   To run with SIS
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS_compile
frerun  -x OM4.xml -p ncrc2.intel -t prod OM4_SIS_baseline -r basic 
   To run with SIS2
fremake -x OM4.xml -p ncrc2.intel -t prod MOM6_SIS2_compile
frerun  -x OM4.xml -p ncrc2.intel -t prod OM4_SIS2_baseline -r basic 


-->

<experimentSuite rtsVersion="4" xmlns:xi="http://www.w3.org/2001/XInclude">
   <property name="RELEASE"      value="tikal_201403"/> <!-- CVS tag for shared source code -->
   <property name="MOM6_DATE"    value="20140618"/>     <!-- git tag date for MOM6 source code -->
   <property name="FRE_STEM"     value="$(RELEASE)_mom6_$(MOM6_DATE)"/>
   <property name="MOM6_GIT_TAG" value="dev/master"/> <!-- git tag for MOM6 source code -->
   <property name="SIS2_GIT_TAG" value="dev/master"/> <!-- git tag for SIS2 source code -->
   <property name="FRE_VERSION"  value="fre/bronx-7"/>

   <!--Production run properties. Users can modify these according to their need and/or performance analysis-->
   <property name="PROD_SIMTIME"   value="10"/>
   <!-- Post-processing start date and chunk lengths -->
   <property name="PP_START_YEAR"  value="1900"/>
   <property name="PP_END_YEAR"    value="1909"/>
   <property name="CHUNK_LENGTH_A" value="5yr"/>
   <property name="ANALYSIS_SWITCH" value="on"/>

   <property name="PROD_RUNTIME"         value="16:00:00"/>
   <property name="PROD_SEGTIME"         value="03:45:00"/>
   <property name="MASK_TABLE"           value="mask_table.1053.90x45"/> <!--layouts must be 90,45-->
   <property name="PROD_NPES"            value="2997"/> <!-- 90*45 - 1053 -->
   <property name="OCN_PROD_LAYOUT"      value="90,45"/>
   <property name="OCN_PROD_IO_LAYOUT"   value="9,5"/>
   <property name="ICE_PROD_LAYOUT"      value="90,45"/>
   <property name="ICE_PROD_IO_LAYOUT"   value="9,5"/>
   <property name="LND_PROD_LAYOUT"      value="90,45"/>
   <property name="FV_PROD_LAYOUT"       value="90,45"/>
  


   <!--Users need not change the following properties -->
   <property name="reference_tag"  value="tikal_mom6_2014.01.17"/> <!-- Reference release tag for existing files in the archives for answer comparison. Used in "REFERENCE" property. -->
   <property name="PROG_MAIN"   value="coupler/coupler_main.o"/>
   <property name="LIBS_ROOT"   value="MOM6_SIS_libs_compile"/>
   <property name="FMS_LIB_DIR" value="./$(LIBS_ROOT)/$(platform)-$(target)/exec"/>
   <property name="MOM6_SRC"    value="$root/$(LIBS_ROOT)/src/mom6"/> 

   <!-- The following properties are for testing/debugging purposes and should normally be empty-->
   <property name="MODIFIER"     value=""/>  
   <property name="DEBUGLEVEL"   value=""/>

   <setup>
    <!-- MDBI -->
    <fmsRelease>fmsversion</fmsRelease>
    <!-- /MDBI -->

<!-- ncrc platforms -->
	
    <platform name="ncrc2.intel">
      <project>gfdl_o</project>
      <directory stem="$(FRE_STEM)"/>
         <directory>
            <!--unswept locations-->
            <root>&ROOT_LOCATION;/$USER/$(FRE_STEM)</root>
            <scripts>&ROOT_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/scripts</scripts>
            <state>&ROOT_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/state</state>
            <!--swept locations (including the staged archive location)-->
            <archive>&ARCH_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)</archive>
            <stdout>&ARCH_LOCATION;/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)/stdout</stdout>
            <work>&ARCH_LOCATION;/$USER/work/$(FRE_STEM)/$FRE_JOBID</work>
         </directory>
 
      <csh><![CDATA[
          source $MODULESHOME/init/csh
          module use -a /ncrc/home2/fms/local/modulefiles
          module unload PrgEnv-pgi PrgEnv-pathscale PrgEnv-intel PrgEnv-gnu PrgEnv-cray
          module unload netcdf fre fre-commands
          module load PrgEnv-intel
          module swap intel intel/12.0.5.220

          module load $(FRE_VERSION)
          setenv KMP_STACKSIZE 512m
          setenv NC_BLKSZ 1M
          alias cpget 'cp \!^ \!^.copy ; \rm -f \!^ ; mv \!^.copy \!^ ; chmod +w \!^ '
     ]]></csh>

     <property name="NCRC_PLATFORM"    value="$(platform)"/>
     <property name="GFDL_PLATFORM"    value="gfdl"/>
     <property name="SGI_FLAGS"        value=""/>
     <property name="MY_ROOT"          value="$(rootDir)"/>
     <property name="FMS_ARCHIVE_ROOT" value="$CDATA/fms"/>
     <property name="F2003_FLAGS"      value="-DINTERNAL_FILE_NML -g -traceback"/> <!-- -g -traceback -->
     <property name="TAREXT"           value="tar"/>
     <property name="REFERENCE"        value="/lustre/f1/unswept/Niki.Zadeh/$(reference_tag)/$(name)/$(platform)-$(target)"/>
     <property name="NB_ROOT"          value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
 
    </platform>

    <platform name="ncrc2.default">
      <xi:include xpointer="xpointer(//setup/platform[@name='ncrc2.intel']/node())" />
    </platform>

    <platform name="ncrc2.pgi">
      <project>gfdl_o</project>
      <directory stem="$(FRE_STEM)"/>
 
      <csh><![CDATA[
          source $MODULESHOME/init/csh
          module use -a /ncrc/home2/fms/local/modulefiles
          module unload PrgEnv-pgi PrgEnv-pathscale PrgEnv-intel PrgEnv-gnu PrgEnv-cray
          module unload netcdf fre fre-commands

          module load $(FRE_VERSION)
          setenv KMP_STACKSIZE 512m
          setenv NC_BLKSZ 1M
          alias cpget 'cp \!^ \!^.copy ; \rm -f \!^ ; mv \!^.copy \!^ ; chmod +w \!^ '
     ]]></csh>

     <property name="NCRC_PLATFORM"    value="$(platform)"/>
     <property name="GFDL_PLATFORM"    value="gfdl"/>
     <property name="SGI_FLAGS"        value=""/>
     <property name="MY_ROOT"          value="$(rootDir)"/>
     <property name="FMS_ARCHIVE_ROOT" value="$CDATA/fms"/>
     <property name="F2003_FLAGS"      value="-DINTERNAL_FILE_NML -g -traceback"/> <!-- -g -traceback -->
     <property name="TAREXT"           value="tar"/>
     <property name="REFERENCE"        value="/lustre/f1/unswept/Niki.Zadeh/$(reference_tag)/$(name)/$(platform)-$(target)"/>
     <property name="NB_ROOT"          value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
 
    </platform>
<!-- gfdl platforms -->

    <platform name="gfdl.ncrc2-intel">
     <property name="NB_ROOT"      value="/nbhome/$USER/$(FRE_STEM)$(DEBUGLEVEL)/$(name)"/>
     <directory stem="$(FRE_STEM)">
     <!-- MDBI requires these to be listed in order to show the path under "Platform Environment" -->
        <archive>$ARCHIVE/$(FRE_STEM)$(DEBUGLEVEL)/$(name)/$(platform)-$(target)</archive>
        <analysis>$(NB_ROOT)</analysis>
        <ptmp>/ptmp/$USER</ptmp>
     <!-- /MDBI -->
     </directory>
     <property name="F2003_FLAGS"   value=""/>
     <property name="TAREXT"        value="tar"/>
     <property name="GFDL_PLATFORM" value="gfdl"/>
     <property name="NCRC_PLATFORM" value="ncrc2"/>
     <property name="MY_ROOT"          value="$(rootDir)"/>
        <csh><![CDATA[
           source $MODULESHOME/init/csh
           module use -a /home/John.Krasting/local/modulefiles
           module purge
           module load jpk-analysis/0.0.4
           module load $(FRE_VERSION)

           #Some tricks to use the refineDiag and analysis scripts from a checkout of MOM6 at gfdl 
           setenv FREVERSION $(FRE_VERSION)           
           setenv NBROOT $(NB_ROOT)
           mkdir -p $NBROOT
           cd $NBROOT
/home/Niki.Zadeh/bin/git_clone_mom6_fix.csh 
         ]]></csh>
<!--The following are not used, but needed by fre -->
     <property name="SGI_FLAGS" value=""/>
     <property name="REFERENCE" value=""/>
    </platform>

    <platform name="gfdl.ncrc2-default">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.ncrc2-intel']/node())" />
    </platform>
    <platform name="gfdl.default">
      <xi:include xpointer="xpointer(//setup/platform[@name='gfdl.ncrc2-intel']/node())" />
    </platform>

</setup>

   <property name="MY_LIBS"     value="$(MY_ROOT)/$(FMS_LIB_DIR)"/>

   <experiment name="MOM6_SIS_libs_compile">
      <description>
Make the executable for ocean-ice experiments.
      </description>
      <component name="fms" paths="shared" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <source>
            <codeBase version="$(RELEASE)"> shared </codeBase>
	    <!--The following update is needed to run in debug mode with Intel-->
	    <csh>
	      cvs up -r tikal_bugfix_z1l shared/mpp/include/mpp_update_domains2D.h
	    </csh>
         </source>
         <compile>
            <cppDefs>-Duse_libMPI -Duse_netCDF $(F2003_FLAGS)</cppDefs>
         </compile>
         <!-- MDBI --> 
         <description domainName="infrastructure" communityName="FMS" communityVersion="$(RELEASE)" communityGrid="NA"/>
      </component>

      <component name="mom6" requires="fms" paths="mom6/config_src/dynamic mom6/config_src/coupled_driver mom6/src/*/ mom6/src/*/*/">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/github_mirror">
            <codeBase version="$(MOM6_GIT_TAG)"> noaa-gfdl-mom6.git </codeBase>
            <csh> mv noaa-gfdl-mom6 mom6 </csh>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]> </cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="Ocean" communityName="GFDL-MOM6" communityVersion="$(MOM6_GIT_TAG)" communityGrid="Tripolar"/>
      </component>

<!--Since SIS2 needs ice_param there is a dependency that may damage the compile if bith ice_sis and sis2 try to cvs co ice_params at the same time. We should put ice_param files under sis2 git 
-->
      <component name="sis2" paths="sis2 ice_param" requires="fms mom6" includeDir="$root/$(LIBS_ROOT)/src/mom6/src/framework" > 
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/github_mirror">
	   <codeBase version="$(SIS2_GIT_TAG)"> noaa-gfdl-sis2.git </codeBase> 
            <csh> mv noaa-gfdl-sis2 sis2 ; cvs co -r $(RELEASE) ice_param </csh> 
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]>
            </cppDefs>
         </compile>
      </component>

      <component name="ice_sis" paths="ice_param ice_sis" requires="fms">   
         <source>
            <codeBase version="$(RELEASE)"> ice_param ice_sis </codeBase>
         </source>
         <compile>
            <cppDefs>$(F2003_FLAGS)</cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="Sea Ice SIS" communityName="GFDL-SIS" communityVersion="$(RELEASE)" communityGrid="Tripolar"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <source>
            <codeBase version="$(RELEASE)"> land_null </codeBase>
         </source>
         <!-- MDBI -->
         <description domainName="NA" communityName="NA" communityVersion="NA" communityGrid="NA"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
         <source>
            <codeBase version="$(RELEASE)"> atmos_null atmos_param/{monin_obukhov,diag_integral} </codeBase>
         </source>
         <!-- MDBI -->
         <description domainName="NA" communityName="NA" communityVersion="NA" communityGrid="NA"/>
      </component>
   </experiment>

   <experiment name="MOM6_SIS_compile" inherit="MOM6_SIS_libs_compile">
      <component paths="shared" name="fms" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <library path="$(MY_LIBS)/fms/libfms.a" headerDir="$(MY_LIBS)/fms"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <library path="$(MY_LIBS)/land_null/libland_null.a" headerDir="$(MY_LIBS)/land_null"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
          <library path="$(MY_LIBS)/atmos_null/libatmos_null.a" headerDir="$(MY_LIBS)/atmos_null"/>
      </component>
      <component paths="mom6" requires="fms" name="mom6">
         <library path="$(MY_LIBS)/mom6/libmom6.a" headerDir="$(MY_LIBS)/mom6"/>
      </component> 
      <component paths="ice_sis" requires="fms" name="ice_sis">
         <library path="$(MY_LIBS)/ice_sis/libice_sis.a" headerDir="$(MY_LIBS)/ice_sis"/>
      </component> 
      <component name="coupler" paths="coupler" requires="fms land_null atmos_null ice_sis mom6">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> coupler.git </codeBase>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="FMS Coupler" communityName="coupler" communityVersion="$(RELEASE)" communityGrid="NA"/>      </component>
   </experiment>
    <experiment name="MOM6_SIS2_compile" inherit="MOM6_SIS_libs_compile">
      <component paths="shared" name="fms" includeDir="$root/$(LIBS_ROOT)/src/shared/include">
         <library path="$(MY_LIBS)/fms/libfms.a" headerDir="$(MY_LIBS)/fms"/>
      </component>
      <component name="land_null" paths="land_null" requires="fms">
         <library path="$(MY_LIBS)/land_null/libland_null.a" headerDir="$(MY_LIBS)/land_null"/>
      </component>
      <component name="atmos_null" paths="atmos_null atmos_param" requires="fms">
          <library path="$(MY_LIBS)/atmos_null/libatmos_null.a" headerDir="$(MY_LIBS)/atmos_null"/>
      </component>
      <component paths="mom6" requires="fms" name="mom6">
         <library path="$(MY_LIBS)/mom6/libmom6.a" headerDir="$(MY_LIBS)/mom6"/>
      </component> 
      <component paths="sis2" requires="fms" name="sis2">
         <library path="$(MY_LIBS)/sis2/libsis2.a" headerDir="$(MY_LIBS)/sis2"/>
      </component> 
      <component name="coupler" paths="coupler" requires="fms land_null atmos_null sis2 mom6">
         <source versionControl="git" root="http://gitlab.gfdl.noaa.gov/fms">
            <codeBase version="$(RELEASE)"> coupler.git </codeBase>
         </source>
         <compile>
            <cppDefs><![CDATA[$(F2003_FLAGS) -D_FILE_VERSION="'"`git-version-string $<`"'"]]></cppDefs>
         </compile>
         <!-- MDBI -->
         <description domainName="FMS Coupler" communityName="coupler" communityVersion="$(RELEASE)" communityGrid="NA"/>      </component>
   </experiment>


<experiment name="OM4_SIS_baseline" inherit="MOM6_SIS_compile">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" communityExperimentID="$(name)" >
 global 1/4 degree z test case
</description>  
<!-- MDBI --> 
    <realization r="1" i="1" p="1"/>
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
<!-- /MDBI -->

     <input>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_domain_decomp']/input/node())"/>

      <!--MOM6 Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='OM4_data']/input/node())"/>
      <!--SIS Input datasets-->
      <xi:include xpointer="xpointer(//experiment[@name='SIS_data']/input/node())"/>

      <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/input.nml</dataSource>
     </dataFile>
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/field_table</dataSource>
     </dataFile>

      <!--OM4 gridSpec mosaic datasets-->
      <dataFile label="gridSpec" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/grid_spec.nc</dataSource>
        <dataSource site="gfdl">/archive/gold/datasets/OM4_025/mosaic.v20140610.unpacked/grid_spec.nc</dataSource> 
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/land_mask.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_hgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_mask.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ocean_topog.nc</dataSource>
       <!--hsmget cannot get this  <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/topog.nc</dataSource> -->
      </dataFile>

      <!--OM4 CORE forcing datasets-->
      <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/data_table</dataSource>
      </dataFile>
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ncar_precip.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/ncar_rad.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/q_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/runoff.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/salt_restore.v20140616.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/slp.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/t_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/u_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/v_10_mod.clim.nc</dataSource>
      </dataFile>

      <diagTable>
$name
$baseDate
      </diagTable>


      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>

     <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = $domains_stack_size
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         threading_write='single'
         fileset_write='single'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>

     <namelist name="atmos_model_nml" >
       layout=$fv_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$land_layout
       mask_table='INPUT/$ocn_mask_table'
     </namelist>

   
   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"  npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>
       <regression name="timing">
         <run days="10"   npes="576"   runTimePerJob="00:30:00"/>
         <run days="10"   npes="1152"  runTimePerJob="00:30:00"/>
         <run days="10"   npes="2304"  runTimePerJob="00:30:00"/>
         <run days="10"   npes="3240"  runTimePerJob="00:30:00"/>
         <run days="10"   npes="2432"  runTimePerJob="00:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2996pe/restart/19000111.$(TAREXT)"/>

   </runtime>
    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>

  </experiment>

  <experiment name="OM4_domain_decomp">
    <input>
      <csh><![CDATA[
set domains_stack_size = "3097152"

if ( "$npes" == "288" ) then
  set fv_layout    =   "24,12"; set fv_io_layout    =  "1,4"
  set land_layout  =   "24,12"; set land_io_layout  =  "1,4"
  set ice_layout   =   "24,12"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "24,12"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "288"

else if ( "$npes" == "576" ) then
  set fv_layout    =   "24,24"; set fv_io_layout    =  "1,4"
  set land_layout  =   "24,24"; set land_io_layout  =  "1,4"
  set ice_layout   =   "24,24"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "0,0"  ; set ocn_io_layout   =  "1,1"; set ocn_mask_table = "MOM_mask_table"
  set ocean_npes = "576"

else if ( "$npes" == "1152" ) then
  set fv_layout    =   "32,36"; set fv_io_layout    =  "1,4"
  set land_layout  =   "32,36"; set land_io_layout  =  "1,4"
  set ice_layout   =   "32,36"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "32,36"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes = "1152"
#npes= 1152  main_loop= 1085.141626  ATM= 47.583859  OCN= 1036.583676  SYPD= 2.1814

else if ( "$npes" == "2304" ) then
  set fv_layout    =   "32,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "32,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "32,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "32,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes = "2304"
#npes= 2304  main_loop= 603.878142  ATM= 37.217106  OCN= 565.590432  SYPD= 3.91987


else if ( "$npes" == "3240" ) then
  set fv_layout    =   "45,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "45,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "45,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "45,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes   = "3240"
#npes= 3240  main_loop= 464.708698  ATM= 39.759137  OCN= 423.801078  SYPD= 5.09378

else if ( "$npes" == "2432" ) then
  set fv_layout    =   "45,72"; set fv_io_layout    =  "1,4"
  set land_layout  =   "45,72"; set land_io_layout  =  "1,4"
  set ice_layout   =   "45,72"; set ice_io_layout   =  "1,4"
  set ocn_layout   =   "45,72"; set ocn_io_layout   =  "1,4"; set ocn_mask_table = "mask_table.808.45x72"
  set do_ocean = "true"
  set ocean_npes   = "2432"
#npes= 2432  main_loop= 458.382556  ATM= 33.484085  OCN= 423.827549  SYPD= 5.16408

else if ( "$npes" == "4050" ) then
  set fv_layout    =   "90,45"; set fv_io_layout    =  "9,5"
  set land_layout  =   "90,45"; set land_io_layout  =  "9,5"
  set ice_layout   =   "90,45"; set ice_io_layout   =  "9,5"
  set ocn_layout   =   "90,45"; set ocn_io_layout   =  "9,5"; set ocn_mask_table = "MOM_mask_table"
  set do_ocean = "true"
  set ocean_npes   = "4050"

else if ( "$npes" == "2997" ) then
  set fv_layout    =   "90,45"; set fv_io_layout    =  "9,5"
  set land_layout  =   "90,45"; set land_io_layout  =  "9,5"
  set ice_layout   =   "90,45"; set ice_io_layout   =  "9,5"
  set ocn_layout   =   "90,45"; set ocn_io_layout   =  "9,5"; set ocn_mask_table = "mask_table.1053.90x45"
  set do_ocean = "true"
  set ocean_npes   = "2997"
#npes= 2997  main_loop= 395.756260  ATM= 33.947977  OCN= 361.032958  SYPD= 5.98127

else
  if ( $echoOn ) unset echo
  echo "*ERROR*: npes == '$npes' is not supported in this xml."
  if ( $echoOn ) set echo
  exit 1
endif

cat > $work/INPUT/MOM_layout << LAYOUT_EOF
LAYOUT = $ocn_layout
#override IO_LAYOUT = $ocn_io_layout
MASKTABLE = $ocn_mask_table
LAYOUT_EOF

# runCommand:
  alias runCommand "aprun -n $ocean_npes -d 1 ./$executable:t"
      ]]></csh>

    </input>
  </experiment>

  <experiment name="OM4_data">
    <input>
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/MOM_input</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/layer_coord.nc</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/seawifs_1998-2006_smoothed_2X.v20140616.nc</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/tidal_amplitude.v20140616.nc</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/MOM_channels_global_025</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/vgrid_75_2m.nc</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/WOA05_pottemp_salt.nc </dataSource>

       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/mask_table.808.45x72</dataSource>
       <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/INPUT/mask_table.1053.90x45</dataSource>
     </dataFile>      
      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/diag_table.MOM6</dataSource>
      </dataFile>

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_layout','INPUT/MOM_override'
     </namelist>

     <csh type="always"><![CDATA[
if ( $ireload == 1 ) then
 if ( $irun == 1 ) then
  set restart_flag = 'n'
 else
  set restart_flag = 'r'
 endif
else
  set restart_flag = 'r'
endif


ln -s $work/INPUT/ocean_topog.nc $work/INPUT/topog.nc 

touch $work/INPUT/MOM_override

      ]]></csh>
 
     </input>

  </experiment>

  <experiment name="SIS_data">
    <input>

     <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/OM4_025/diag_table.SIS</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/OM4_025/diag_table.SIS</dataSource>
     </dataFile>
      
     <namelist name="ice_model_nml">
           layout = $ice_layout
           io_layout = $ice_io_layout
           mask_table='INPUT/$ocn_mask_table'
           nsteps_dyn=144
           nsteps_adv=2
           num_part = 6
           wd_turn = 0.0
           spec_ice=.false.
           ice_bulk_salin = 0.05
           alb_sno = 0.85                    ! keep CM2 setting
           alb_ice = 0.65                    ! keep CM2 setting
           t_range_melt = 1.0                ! NOTE: CM2 uses 1.0
           heat_rough_ice = 5.0e-4
           cm2_bugs = .false.
           do_icebergs = .false.
           add_diurnal_sw = .true.
           do_ice_limit=.false.
           max_ice_limit=4.0
           channel_viscosity=5.e5
           h_lo_lim = 1.e-10
      </namelist>
      <namelist name="icebergs_nml">
        really_debug=.FALSE.
        debug=.FALSE.
        verbose=.FALSE.
        verbose_hrs=2400
      </namelist>

      <namelist name="ocean_albedo_nml">
            ocean_albedo_option = 2
      </namelist>
      <namelist name="ocean_rough_nml">
            rough_scheme = 'beljaars'
      </namelist>
     </input>
  </experiment>



  
<experiment name="OM4_SIS_baseline_old" inherit="MOM6_SIS_compile">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" communityExperimentID="$(name)" >
 global 1/4 degree z test case
</description>  
<!-- MDBI --> 
    <realization r="1" i="1" p="1"/>
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
<!-- /MDBI -->

     <input>
     <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/input.nml</dataSource>
     </dataFile>
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/field_table</dataSource>
     </dataFile>
     <dataFile label="gridSpec" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/grid_spec.nc</dataSource>
        <dataSource site="gfdl">/archive/gold/datasets/MOM6z_SIS_025/siena/mosaic.unpacked/grid_spec.nc</dataSource> 
     </dataFile>
     <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/data_table</dataSource>
     </dataFile>
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/MOM_input</dataSource>
     </dataFile>

      <!--gridSpec mosaic datasets-->
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/land_mask.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/layer_coord.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/ocean_hgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/ocean_mask.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/ocean_mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/ocean_topog.nc</dataSource>
       <!--hsmget cannot get this  <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/topog.nc</dataSource> -->
      </dataFile>

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/seawifs_1998-2006_smoothed_2x_v2.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/tidal_amplitude.v20140328.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/MOM_channels_global_025</dataSource>
	 <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/vgrid_cm4.nc</dataSource>
	 <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/WOA05_pottemp_salt.nc </dataSource>
      </dataFile>

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/ncar_precip.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/ncar_rad.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/q_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/runoff.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/salt_restore_v3.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/slp.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/t_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/u_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/v_10_mod.clim.nc</dataSource>
      </dataFile>

      <!--Get the masktables too, since they may be needed in the children tests-->
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.34.16x18</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.99.32x18</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.246.32x36</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.548.32x72</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.808.45x72</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.1029.45x90</dataSource> 
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.1404.45x120</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.1054.90x45</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.703.180x18</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/INPUT/mask_table.873.120x30</dataSource>
      </dataFile>

      <diagTable>
$name
$baseDate
      </diagTable>

      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/diag_table.MOM6</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/MOM6z_SIS_025/diag_table.MOM6</dataSource>
      </dataFile>

      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/diag_table.SIS</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/MOM6z_SIS_025/diag_table.SIS</dataSource>
      </dataFile>

      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_layout','INPUT/MOM_override'  
     </namelist>

     <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = 8000000
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         threading_write='single'
         fileset_write='single'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>
     <!-- The following namelist modifications are necessary for production runs since overrideParams won't work for production
       overrideParams="
         atmos_model_nml:layout=90,45;atmos_model_nml:mask_table='INPUT/mask_table.1054.90x45';
         land_model_nml:layout=90,45;land_model_nml:mask_table='INPUT/mask_table.1054.90x45';
         ice_model_nml:layout=90,45;ice_model_nml:io_layout=3,3;ice_model_nml:mask_table='INPUT/mask_table.1054.90x45'
                      "
      -->
     <namelist name="atmos_model_nml" >
       layout=$(FV_PROD_LAYOUT)
       mask_table='INPUT/$(MASK_TABLE)'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$(LND_PROD_LAYOUT)
       mask_table='INPUT/$(MASK_TABLE)'
     </namelist>
     <namelist name="ice_model_nml" >
       layout=$(ICE_PROD_LAYOUT)
       io_layout=$(ICE_PROD_IO_LAYOUT)
       mask_table='INPUT/$(MASK_TABLE)'
           nsteps_dyn=144
           nsteps_adv=2
           num_part = 6
           wd_turn = 0.0
           spec_ice=.false.
           ice_bulk_salin = 0.005
           alb_sno = 0.85                    ! keep CM2 setting
           alb_ice = 0.65                    ! keep CM2 setting
           t_range_melt = 1.0                ! NOTE: CM2 uses 1.0
           heat_rough_ice = 5.0e-4
           cm2_bugs = .false.
           do_icebergs = .false.
           atmos_winds=.true.
           add_diurnal_sw = .true.
           do_ice_limit=.false.
           max_ice_limit=4.0
           channel_viscosity=5.e5
           chan_cfl_limit=0.001
           h_lo_lim = 1.e-10
    </namelist>

    <csh type="always"><![CDATA[
cd $work/INPUT
ln -s ocean_topog.nc topog.nc   #hsmget has problem with topog.nc
touch $work/INPUT/MOM_override 
cat > $work/INPUT/MOM_layout << LAYOUT_EOF
LAYOUT = $(OCN_PROD_LAYOUT)
#override IO_LAYOUT = $(OCN_PROD_IO_LAYOUT) 
#override MASKTABLE = $(MASK_TABLE)
LAYOUT_EOF
cd $work
    ]]></csh>
  
    <csh type="always">
      <![CDATA[
#------------------------------------------
## Find out whether to restart.

if ( $ireload == 1 ) then
 if ( $irun == 1 ) then
  set restart_flag = 'n'
 else
  set restart_flag = 'r'
 endif
else
  set restart_flag = 'r'
endif
cd $work
## Run the model
#------------------------------------------
      ]]>
    </csh>    
   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"   npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2996pe/restart/19000111.$(TAREXT)"/>

   </runtime>
    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>

  </experiment>

  <!-- OCEAN  and ICE post-processing-->
  <experiment name="OM4_postprocess">

      <postProcess> 
         <csh><![CDATA[
         cd $work/RESTART
         ncrcat icebergs.res.nc.* icebergs.res.nc
         rm -f icebergs.res.nc.*
         cd $work
         ncrcat iceberg_trajectories.nc.* iceberg_trajectories.nc
         rm -f iceberg_trajectories.nc.* 
         #Save the last line of timestats without the first (step number) column as a signature of MOM6 answers
         tail -1 timestats | cut -c8- > RESTART/$enddate.timestats.res
         #Save the whole timestats under ascii/
         mv timestats $enddate.timestats
         mv timestats.nc $enddate.timestats.nc

         #Make a directory to trick FRE to pick up and archive in ascii
         mkdir extra.results

         mv *velocity_truncations CPU_stats MOM_parameter_doc* extra.results/

         ]]></csh>

      <!--REFINE DIAG SCRIPT to untar the files under history/ -->
      <refineDiag script="$(NB_ROOT)/mom6/tools/analysis/MOM6_refineDiag.csh"/>
      <!--PostProcessing component models-->
      <component type="ocean_monthly"   start="$(PP_START_YEAR)" source="ocean_month">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)" source="ocean_month">
          <analysis switch="$(ANALYSIS_SWITCH)" startYear="$(PP_START_YEAR)" endYear="$(PP_END_YEAR)" script="$(NB_ROOT)/mom6/examples/ocean_SIS/MOM6z_SIS_025/ocn_monthly.frepp"/>
        </timeSeries>
      </component>
      <component type="ocean_annual" start="$(PP_START_YEAR)"  source="ocean_annual"> 
        <timeSeries freq="annual"  chunkLength="$(CHUNK_LENGTH_A)" source="ocean_annual">
          <analysis switch="$(ANALYSIS_SWITCH)" startYear="$(PP_START_YEAR)" endYear="$(PP_END_YEAR)" script="$(NB_ROOT)/mom6/examples/ocean_SIS/MOM6z_SIS_025/ocn_annual.frepp"/>
        </timeSeries>
      </component>

      <component type="ice"  start="$(PP_START_YEAR)"  source="ice_month">
        <timeSeries freq="monthly" chunkLength="$(CHUNK_LENGTH_A)"  source="ice_month">
	   <analysis switch="$(ANALYSIS_SWITCH)" startYear="$(PP_START_YEAR)" cumulative="yes" script="$(NB_ROOT)/mom6/tools/analysis/Krasting-SeaIce.csh"/>
	</timeSeries>   
        
        <timeAverage source="annual"  interval="$(CHUNK_LENGTH_A)"/>
      </component>

      <!--The following mdbi_logger component is a trial to make the db ingestor run when the yearly data arrives
	  in order to update the "Monitoring" section of the DB.
	  The intention was not to do anything besides that update. We do not really want an annual timeseries.
	  But unfortunately frepp still tries to create a timeseries. -->
      <component type="mdbi_logger"   start="$(PP_START_YEAR)">  
        <timeSeries freq="annual"  chunkLength="1yr" source="ocean_annual">
         <variables>temp</variables>
         <analysis switch="on" cumulative="no" script="$FRE_CURATOR_HOME/share/bin/database_ingestor.csh"/>
        </timeSeries>
      </component>

     </postProcess>

</experiment>

<experiment name="OM4_SIS_baseline_TEST" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="TEST" communityModel="OM4_SIS_baseline_TEST $(FRE_STEM)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" communityExperimentID="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>
</experiment>

<experiment name="OM4_SIS2_baseline" inherit="MOM6_SIS2_compile">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS2 $(MOM6_GIT_TAG)" communityModelID="OWG_OM4_SIS2" communityExperimentName="$(name)" communityExperimentID="$(name)" >
 global 1/4 degree z test case
</description>  
<!-- MDBI --> 
    <realization r="1" i="1" p="1"/>
    <scenario 
      communityForcing="CORE"
      parentExperimentID="N/A" 
      parentExperimentRIP="N/A" 
      startTime="$(PP_START_YEAR)"
      endTime="$(PP_END_YEAR)" 
      branch_time="0.0">
    </scenario>
<!-- /MDBI -->

     <input>
     <dataFile label="namelist" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/input.nml</dataSource>
     </dataFile>
     <dataFile label="fieldTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/field_table</dataSource>
     </dataFile>
     <dataFile label="gridSpec" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/grid_spec.nc</dataSource>
        <dataSource site="gfdl">/archive/gold/datasets/MOM6z_SIS_025/siena/mosaic.unpacked/grid_spec.nc</dataSource> 
     </dataFile>
     <dataFile label="dataTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/data_table</dataSource>
     </dataFile>
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/MOM_input</dataSource>
     </dataFile>
     <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/SIS_input</dataSource>
     </dataFile>

      <!--gridSpec mosaic datasets-->
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/atmos_mosaic_tile1Xland_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/atmos_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/land_mask.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/land_mosaic_tile1Xocean_mosaic_tile1.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/layer_coord.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/ocean_hgrid.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/ocean_mask.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/ocean_mosaic.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/ocean_topog.nc</dataSource>
       <!--hsmget cannot get this  <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/topog.nc</dataSource> -->
      </dataFile>

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/seawifs_1998-2006_smoothed_2x_v2.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/tidal_amplitude.v20140328.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/MOM_channels_global_025</dataSource>
	 <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/vgrid_cm4.nc</dataSource>
	 <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/WOA05_pottemp_salt.nc </dataSource>
      </dataFile>

      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/ncar_precip.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/ncar_rad.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/q_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/runoff.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/salt_restore_v3.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/slp.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/sst_ice_clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/t_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/u_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/v_10_mod.clim.nc</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/sit_sic_MOM6z_025_v1.nc</dataSource>
      </dataFile>

      <!--Get the masktables too, since they may be needed in the children tests-->
      <dataFile label="input" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.34.16x18</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.99.32x18</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.246.32x36</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.548.32x72</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.808.45x72</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.1029.45x90</dataSource> 
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.1404.45x120</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.1054.90x45</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.703.180x18</dataSource>
         <dataSource platform="$(platform)">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/INPUT/mask_table.873.120x30</dataSource>
      </dataFile>

<!--With the followin initCond crashed in 1 day
      <dataFile label="initCond" target="INPUT/" chksum="" size="" timestamp="">
         <dataSource platform="$(platform)">/lustre/f1/Niki.Zadeh/tikal_201403_mom6_20140506/MOM6z_SIS2_025_baseline_493days/ncrc2.intel-prod/1x0m128d_2996pe/restart/19010509.tar</dataSource>
      </dataFile>
-->
      
      <diagTable>
$name
$baseDate
      </diagTable>
      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS/MOM6z_SIS_025/diag_table.MOM6</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS/MOM6z_SIS_025/diag_table.MOM6</dataSource>
      </dataFile>

      <dataFile label="diagTable" target="INPUT/" chksum="" size="" timestamp="">
        <dataSource site="ncrc">$(MOM6_SRC)/examples/ocean_SIS2/MOM6z_SIS2_025/diag_table.SIS2</dataSource>
        <dataSource site="gfdl">$(NB_ROOT)/mom6/examples/ocean_SIS2/MOM6z_SIS2_025/diag_table.SIS2</dataSource>
      </dataFile>

      <namelist name="coupler_nml">
       months = $months,
       days   = $days,
       current_date = 1900,1,1,0,0,0,
       hours = 0
       minutes = 0
       seconds = 0
       calendar = 'NOLEAP',
       dt_cpld  = 3600,
       dt_atmos = 3600,
       do_atmos = .false.,
       do_land = .false.,
       do_ice = .true.,
       do_ocean = .true.,
       atmos_npes = 0,
       ocean_npes = 0,
       concurrent = .false.
       use_lag_fluxes=.false. 
     </namelist>

     <namelist name="MOM_input_nml" >
         output_directory = './',
         input_filename = '$restart_flag'
         restart_input_dir = 'INPUT/',
         restart_output_dir = 'RESTART/',
         parameter_filename = 'INPUT/MOM_input','INPUT/MOM_layout','INPUT/MOM_override'  
     </namelist>

      <namelist name="SIS_input_nml" >
        output_directory = './',
        input_filename = 'n'
        restart_input_dir = 'INPUT/',
        restart_output_dir = 'RESTART/',
        parameter_filename = 'INPUT/SIS_input','INPUT/SIS_layout','INPUT/SIS_override' 
     </namelist>

    <namelist name="fms_nml">
            clock_grain='ROUTINE'
            clock_flags='NONE'
            domains_stack_size = 8000000
            stack_size =0
      </namelist>
     <namelist name="fms_io_nml" >
         fms_netcdf_restart=.true.
         threading_read='multi'
         threading_write='single'
         fileset_write='single'
         max_files_r = 200
         max_files_w = 200
         checksum_required = .false. ! This is needed to be able to restart the Ice under GNU. ref. Redmine issue 2000
     </namelist>
     <!-- The following namelist modifications are necessary for production runs since overrideParams won't work for production
       overrideParams="
         atmos_model_nml:layout=90,45;atmos_model_nml:mask_table='INPUT/mask_table.1054.90x45';
         land_model_nml:layout=90,45;land_model_nml:mask_table='INPUT/mask_table.1054.90x45';
         ice_model_nml:layout=90,45;ice_model_nml:io_layout=3,3;ice_model_nml:mask_table='INPUT/mask_table.1054.90x45'
                      "
      -->
     <namelist name="atmos_model_nml" >
       layout=$(FV_PROD_LAYOUT)
       mask_table='INPUT/$(MASK_TABLE)'
     </namelist>
     <namelist name="land_model_nml" >
       layout=$(LND_PROD_LAYOUT)
       mask_table='INPUT/$(MASK_TABLE)'
     </namelist>
     <namelist name="ice_model_nml" >
       layout=$(ICE_PROD_LAYOUT)
       io_layout=$(ICE_PROD_IO_LAYOUT)
       mask_table='INPUT/$(MASK_TABLE)'
    </namelist>

    <csh><![CDATA[
cd $work/INPUT
ln -s ocean_topog.nc topog.nc   #hsmget has problem with topog.nc
cd $work
touch $work/INPUT/SIS_override
cat > $work/INPUT/SIS_layout << OVERRIDE_EOF
LAYOUT = $(ICE_PROD_LAYOUT)
#override IO_LAYOUT = $(ICE_PROD_IO_LAYOUT)
#override MASKTABLE = $(MASK_TABLE)
OVERRIDE_EOF

touch $work/INPUT/MOM_override 
cat > $work/INPUT/MOM_layout << LAYOUT_EOF
LAYOUT = $(OCN_PROD_LAYOUT)
#override IO_LAYOUT = $(OCN_PROD_IO_LAYOUT) 
#override MASKTABLE = $(MASK_TABLE)
LAYOUT_EOF
    ]]></csh>
  
    <csh type="always">
      <![CDATA[
#------------------------------------------
## Find out whether to restart.

if ( $ireload == 1 ) then
 if ( $irun == 1 ) then
  set restart_flag = 'n'
 else
  set restart_flag = 'r'
 endif
else
  set restart_flag = 'r'
endif
cd $work
## Run the model
#------------------------------------------
      ]]>
    </csh>    
   </input>

   <runtime>   
       <regression name="basic">
         <run days="10"   npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>
       <regression name="rts">
         <run days="5 5"   npes="$(PROD_NPES)"  runTimePerJob="00:30:00"/>
       </regression>

      <production simTime="$(PROD_SIMTIME)" units="years" npes="$(PROD_NPES)" runTime="$(PROD_RUNTIME)">
           <segment simTime="12" units="months" runTime="$(PROD_SEGTIME)"/>
       </production>

      <reference restart="$(REFERENCE)/1x0m10d_2996pe/restart/19000111.$(TAREXT)"/>

   </runtime>

    <postProcess>
      <xi:include xpointer="xpointer(//experiment[@name='OM4_postprocess']/postProcess/node())"/>
    </postProcess>


</experiment>

<experiment name="OM4_SIS2_baseline_TEST" inherit="OM4_SIS2_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="TEST" communityModel="OM4_SIS $(MOM6_GIT_TAG)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" communityExperimentID="$(name)" >
MOM6 wiki: http://wiki.gfdl.noaa.gov/index.php/MOM6
</description>
</experiment>



<experiment name="OM4_SIS_gust_0p03" inherit="OM4_SIS_baseline">
<!--The following description tags are needed to put the experiment in the MDBI-->
<description communityProject="OWG" communityModel="OM4_SIS $(MOM6_GIT_TAG)" communityModelID="OWG_OM4_SIS" communityExperimentName="$(name)" communityExperimentID="$(name)" >
 global 1/4 degree z   GUST_CONST = 0.03
</description>
<!-- MDBI -->
   <input>
     <csh><![CDATA[
cd $work/INPUT
ln -s ocean_topog.nc topog.nc   #hsmget has problem with topog.nc
cat > $work/INPUT/MOM_override << OVERRIDE_EOF
#override GUST_CONST = 0.03
OVERRIDE_EOF
cd $work
     ]]></csh>
   </input>
</experiment>

</experimentSuite>
